title = "Pénztár"
url = "/penztar"
layout = "default"
meta_title = "Pénztár oldal"
meta_description = "Pénztár oldal a Bakonyi Hűtő- és Klímatechnika Kft. weboldalán a bakonyiklima.hu oldalon. Hűtéstechnika 1995 óta országszerte garanciával."
is_hidden = 0
robot_index = "index"
robot_follow = "follow"

[session]
security = "user"
redirect = "belepes"
==
<?php
function onStart() {
    $out = [];
    foreach ($this->cart->cart->items as $item) {
        $outItem = new stdClass;
        $outItem->id  = $item->id;
        $outItem->name = $item->product->name;
        if($item->variant) {
            $outItem->price = $item->product->getItemPrice($item->variant_id);
        } else {
            $outItem->price = $item->product->getItemPrice();
        }
        $outItem->variant = $item->variant ? $item->product->name." ".$item->variant->name : $item->product->name;
        $outItem->quantity = $item->quantity;
        $out[] = $outItem;
    }

    $this['conjuncture'] = json_encode($out);
}
?>
==
<div class="section position-relative" id="checkout-page">
    <div class="container pb-5">
        <div class="row">
            <div class="col-12">
                <h1 class="mt-5 fw-bold color-dark">Pénztár</h1>
            </div>
        </div>
     {% if cart.cart.items|length > 0 %}    
        <div class="row">
            <div class="col-lg-12">
                <form id="form1" class="mt-5" data-request-flash data-request-loading
                    onsubmit="sendOrder(this, event);">
                    <input type="hidden" name="ship_bill_equal" value="1" />
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card mb-3">
                                <div class="card-header fw-bold text-white">
                                    Számlázási adatok
                                </div>
                                <div class="card-body">
                                    <div id="billingData">
                                        {% partial 'cart/billings' %}
                                    </div>
                                </div>
                            </div>
                            <div class="card mb-3">
                                <div class="card-header fw-bold d-flex justify-content-between align-items-center">
                                    <span class="d-inline-block text-white">Szállítási adatok</span>
                                    <span class="d-inline-block float-right">

                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="ship_bill_equal">
                                            <label class="form-check-label text-secondary fw-normal" for="ship_bill_equal">
                                                Más szállítási címet szeretnék megadni!
                                            </label>
                                        </div>

                 
                                    </span>
                                </div>
                                <div class="card-body" id="shipping_adress_card" style="display: none;">
                                    <div id="addressData">
                                        {% partial 'cart/address' %}
                                    </div>
                                </div>
                            </div>
                            <div id="shipping_methods">
                                {% partial 'cart/shipping_methods' %}
                            </div>
                            <div class="card mb-3 mb-md-0">
                                <div class="card-header fw-bold text-white">
                                    Fizetési mód
                                </div>
                                <div class="card-body">
                                    <div id="payments">
                                        {% partial 'cart/payments' %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div id="checkout">
                                {% partial 'cart/checkout' %}
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="row">
            <div class="col-12">
                <h3 class="text-center mb-5 mt-3">Az ön kosara üres!</h3>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% put scripts %}
<script>

    let cartitems = {{ conjuncture|raw }};
    let out = [];
    cartitems.forEach(item => {
        oi = new Object;
        oi.item_id = item.id;
        oi.item_name = item.name;
        oi.price = parseInt(item.price);
        oi.quantity = parseInt(item.quantity);
        if(item.variant) {
            oi.variant = item.variant;
        }
        out.push(oi);
    });
    
    console.log(out);

    window.dataLayer = window.dataLayer || [];
    window.dataLayer.push({
        event: 'checkout',
        ecommerce: {
            // currencyCode: 'HUF',
            checkout: {
                actionField: {step: 1 },
            },
            products: out
        }
    });

    $(document).on("change", "#shipping_methods input", function () {
        let id = $(this).val();

        $.request("onSetCartShipping", {
            data: {
                shipping_mode: id
            }
        });
    });

    $(document).on("change", "#payment_methods_card input", function () {
        let id = $(this).val();

        $.request("onSetCartPayment", {
            data: {
                payment_mode: id
            }
        });
    });

    $("#ship_bill_equal").change(function () {
        if ($(this).is(':checked')) {
            $("#shipping_adress_card").slideDown();
            $("input[name='ship_bill_equal']").val(0);
            $("#shipping_adress_card input").not(".except").prop("required", true);
        }
        else {
            $("#shipping_adress_card").slideUp();
            $("input[name='ship_bill_equal']").val(1);
            $("#shipping_adress_card input").prop("required", false);
        }
    });

    function sendOrder(el, event) {
        event.preventDefault();

        $("form button[type='submit']").prop("disabled", true);
        let shipping = $('input[name="shipping_mode"]:checked').val();
        let payment = $('input[name="payment_mode"]:checked').val();

        if("input[]")

        if (shipping == undefined || payment == undefined) {
            $.oc.flashMsg({
                interval: 2,
                class: 'error',
                text: 'Kérjük válasszon szállítási és fizetési módot!'
            });

            return false;
        }

        $(el).request("onCheckout", {
            success: (data) => {
                $.oc.flashMsg({
                    interval: 2,
                    class: 'success',
                    text: 'Rendelését megkaptuk, köszönjük!'
                });

                setTimeout(function () {
                    location.href = `fizetes/${data.id}`;
                }, 500);
            },
            error: () => {
                $.oc.flashMsg({
                    interval: 2,
                    class: 'error',
                    text: 'Hiba történt a rendelés leadása közben!'
                });

                return false;
            }
        });
    }
</script>
{% endput %}